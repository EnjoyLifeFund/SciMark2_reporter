#!/bin/bash
## Dependency brew install gnu_time , icdiff
## 
dateinfo=$(date +%Y-%m-%d-%H%M);

cpudata () { 
    if [ "$(uname -s)" == "Linux" ]; then
        /bin/cat /proc/cpuinfo && lscpu;
    fi;
    if [ "$(uname -s)" == "Darwin" ]; then
        system_profiler SPHardwareDataType;
    fi
}

function move2folder() {
	mkdir $folder
	yes|mv FFT.o $folder
	yes|mv LU.o $folder
	yes|mv MonteCarlo.o $folder
	yes|mv Random.o $folder
	yes|mv SOR.o $folder
	yes|mv SparseCompRow.o $folder
	yes|mv Stopwatch.o $folder
	yes|mv array.o $folder
	yes|mv kernel.o $folder
	yes|mv scimark2 $folder
	yes|mv scimark2.o $folder
}

function getscore() {
	# Excutable identification
	echo "[Info] Identifying excutable to be 32bit or 64bit: "
	# Small dataset report
	rpname=scimark2.$suffix-$folder
	file ./$folder/scimark2  > $rpname
	uname -a >> $rpname
	cpudata >> $rpname
	echo "[Info] Running Smaller Number ~1024"
	gtime -o scimark2_time.$suffix -v ./$folder/scimark2 >> $rpname
	cat scimark2_time.$suffix >> $rpname
	## Large dataset report
	echo "[Info] Running Larger Number ~1048576"
	gtime -o scimark2_time_large.$suffix -v ./$folder/scimark2 -large  >> $rpname
	cat scimark2_time_large.$suffix >> $rpname
	rm scimark2_time*
	## Read & report rellocaiton
	mkdir -p reports/$dateinfo
	yes|mv $rpname reports/$dateinfo
}


function macdev() {
	echo "________________________________________________________________________________"
	echo "COMPILERS:" $CC @ $CPP @ $CXX @ $CXXCPP 
	echo "FLAGS:"  $ARCHFLAGS @  @ $CFLAGS @ $FFLAGS @ $LDFLAGS
}

function reportdiff () {
	echo "[Info] Report comparision, LEFT: GCC, RIGHT : Clang"
	### sdiff or icdiff
	diff --side-by-side reports/$dateinfo/scimark2.gccscore-gccbin reports/$dateinfo/scimark2.score-newbin > reports/$dateinfo/score.diff
	cat -n reports/$dateinfo/score.diff | grep "|" > score-diff.summary
	cat -n reports/$dateinfo/score.diff
	echo "[DIFF REPORT SUMMARY]"
	gcc -v >>score-diff.summary
	cc -v  >>score-diff.summary
	macdev >>score-diff.summary
	cat score-diff.summary
    yes|mv score-diff.summary reports/$dateinfo
}


## Using mac for scoring
echo "[Info] Building -- Scimark2 Benchmarking using system compiler..."
make > /dev/null
folder=newbin
suffix=score
move2folder > /dev/null
echo "[Info] Testing -- Scimark2 Benchmarking using system compiler..."
getscore

## Using GCC for scoring
echo "[Info] Building -- Scimark2 Benchmarking using GCC-7 compiler..."
./gccmake
folder=gccbin
suffix=gccscore
move2folder > /dev/null
echo "[Info] Testing -- Scimark2 Benchmarking using GCC-7 compiler..."
getscore
reportdiff

